<!DOCTYPE html>
<html>

    <head>
        <title>Algorithm trainer</title>
        <meta charset="utf-8">

        <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
        <link rel="stylesheet" type="text/css" href="style.css">
        <style>

td {
    width: 5em;
}
input {
    width: 100%;
    box-sizing: border-box;
}

#save {
    visibility: hidden;
    padding: 1em;
}
       </style>
    </head>
    <body>
        <button id="save">Save!</button>
        <table id="currentKeymap">
            <tr>
                <th>Key</th>
                <th>Move</th>
            </tr>

            <tbody id="keymapsbody">
                <tr>
                    <td><input value="."/></td>
                    <td><input value="E'" /></td>
                    <td><button> ✅ </button></td>
                    <td><button> ❌ </button></td>
                </tr>
            </tbody>
        </table>
        <button id="add-new"> Add another! </button>
        <button id="reset"> Reset to default! </button>
    </body>

    <script src="js/keymaps.js"></script>
    <script>

let keymapsBody = document.getElementById("keymapsbody");
let saveButton = document.getElementById("save");

let currentKeymap = getKeyMaps();

let isChanging = false;

function notifySaveButton() {
    if (JSON.stringify(currentKeymap) === JSON.stringify(getKeyMaps())) {
        saveButton.style.visibility = "hidden";
    } else {
        saveButton.style.visibility = "visible";
    }
}

function editField(i) {
    let [k, v] = currentKeymap[i];
    let tr = keymapsBody.children[i];
    let key = tr.children[0];
    let move = tr.children[1];

    if (isChanging) {
        rerender(); return;
    }
    isChanging = true;
    key.innerHTML = "";
    let keyField = document.createElement("input");
    keyField.value = k;
    key.appendChild(keyField);

    move.innerHTML = "";
    let moveField = document.createElement("input");
    moveField.value = v;
    move.appendChild(moveField);

    let acceptButton = document.createElement("button");
    acceptButton.innerText = "✅";
    acceptButton.onclick = _e => {
        currentKeymap[i] = [keyField.value, moveField.value];
        rerender();
    };

    let acceptButtonTd = document.createElement("td");
    acceptButtonTd.appendChild(acceptButton);
    tr.appendChild(acceptButtonTd);

    let removeButton = document.createElement("button");
    removeButton.innerText = "❌";
    removeButton.onclick = _e => {
        currentKeymap.splice(i, 1);
        rerender();
    };

    let removeButtonTd = document.createElement("td");
    removeButtonTd.appendChild(removeButton);
    tr.appendChild(removeButtonTd);

    tr.onclick = null;

}

function rerender(quiet=false) {
    if (!quiet) {
        notifySaveButton();
    }
    keymapsBody.innerHTML = "";
    isChanging = false;

    for (let i = 0; i < currentKeymap.length; i++) {
        let [k, v] = currentKeymap[i];
        let key = document.createElement("td");
        key.innerText = k;
        let move = document.createElement("td");
        move.innerText = v;

        let tr = document.createElement("tr");
        tr.appendChild(key);
        tr.appendChild(move);

        keymapsBody.appendChild(tr);
        tr.onclick = _e => editField(i);
    }
}
document.getElementById("add-new").onclick = _ => {
    currentKeymap.push(["keys", "alg"]);
    rerender(true);
    editField(currentKeymap.length - 1);
};

document.getElementById("reset").onclick = _ => {
    currentKeymap = defaultKeymaps;
    rerender(false);
};
saveButton.onclick = _ => {
    localStorage.setItem("keymaps", JSON.stringify(currentKeymap));
    rerender();
}

rerender();

    </script>
</html>
